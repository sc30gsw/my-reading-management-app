# Requirements Document

## Introduction

読書管理アプリケーションにおけるメール/パスワード認証機能の実装。Better Auth 1.3.6を使用したセキュアな認証システムの構築により、個人利用に最適化されたプライベートな読書記録環境を提供する。

**ビジネス価値**: セキュアな個人認証により、メンタルマップや読書記録の安全な管理を実現し、ユーザーが安心してプライベートな読書データを蓄積できる環境を構築する。

## Project Description (User Input)
email and password authentication. No.2.5 at .claude/requirement.md

## Requirements

### Requirement 1: ユーザー登録機能
**User Story:** 読書愛好者として、メールアドレスとパスワードでアカウントを作成したい。それにより、自分だけの読書記録を開始できるため。

#### Acceptance Criteria

1. WHEN ユーザーが未登録のメールアドレスと有効なパスワードを入力してユーザー登録を実行する THEN システムは新しいアカウントを作成し、確認メッセージを表示 SHALL する
2. WHEN ユーザーが既に登録済みのメールアドレスでユーザー登録を試行する THEN システムは「このメールアドレスは既に使用されています」エラーメッセージを表示 SHALL する  
3. WHEN ユーザーが8文字未満のパスワードでユーザー登録を試行する THEN システムは「パスワードは8文字以上で入力してください」エラーメッセージを表示 SHALL する
4. WHEN ユーザーが無効なメール形式でユーザー登録を試行する THEN システムは「有効なメールアドレスを入力してください」エラーメッセージを表示 SHALL する
5. WHERE ユーザー登録フォームが表示されている THE システムは必須項目（メールアドレス、パスワード、パスワード確認）の入力フィールドとバリデーション機能を提供 SHALL する

### Requirement 2: ログイン/ログアウト機能
**User Story:** 登録済みユーザーとして、メールアドレスとパスワードでログインしたい。それにより、自分の読書記録にアクセスできるため。

#### Acceptance Criteria

1. WHEN ユーザーが正しいメールアドレスとパスワードでログインを実行する THEN システムはユーザーを認証し、ダッシュボードページにリダイレクト SHALL する
2. WHEN ユーザーが間違ったメールアドレスまたはパスワードでログインを試行する THEN システムは「メールアドレスまたはパスワードが正しくありません」エラーメッセージを表示 SHALL する
3. WHEN 認証済みユーザーがログアウトボタンをクリックする THEN システムはセッションを無効化し、ログインページにリダイレクト SHALL する
4. WHILE ユーザーがログインセッション中である THE システムは自動的にセッションを維持し、ページリロード時も認証状態を保持 SHALL する
5. WHERE ログインページが表示されている THE システムはメールアドレスとパスワードの入力フィールド、ログインボタン、ユーザー登録リンクを表示 SHALL する

### Requirement 3: プロフィール管理機能  
**User Story:** 認証済みユーザーとして、プロフィール情報を管理したい。それにより、個人設定と読書目標を設定できるため。

#### Acceptance Criteria

1. WHEN 認証済みユーザーがプロフィール設定ページにアクセスする THEN システムは現在のプロフィール情報（表示名、プロフィール画像、読書目標）を表示 SHALL する
2. WHEN ユーザーが表示名を変更して保存する THEN システムは新しい表示名を保存し、「プロフィールが更新されました」確認メッセージを表示 SHALL する
3. WHEN ユーザーが月間読書目標（数値）を設定する THEN システムは正の整数のみを受け付け、無効な値の場合は「1以上の数値を入力してください」エラーメッセージを表示 SHALL する
4. WHEN ユーザーが年間読書目標（数値）を設定する THEN システムは正の整数のみを受け付け、無効な値の場合は「1以上の数値を入力してください」エラーメッセージを表示 SHALL する
5. IF ユーザーがプロフィール画像URLを入力する THEN システムは有効なURL形式のみを受け付け、無効な場合は「有効なURL形式で入力してください」エラーメッセージを表示 SHALL する

### Requirement 4: セッション管理機能
**User Story:** システム管理者として、セキュアなセッション管理を実装したい。それにより、ユーザーのプライベートデータを安全に保護できるため。

#### Acceptance Criteria

1. WHEN ユーザーがログインに成功する THEN システムはセキュアなセッショントークンを生成し、Better Authのセッション管理機能で管理 SHALL する
2. WHILE ユーザーのセッションがアクティブである THE システムは24時間の自動期限切れタイマーを維持 SHALL する
3. WHEN ユーザーのセッションが期限切れになる THEN システムは自動的にログアウトし、ログインページにリダイレクト SHALL する
4. WHERE 認証が必要なページにアクセスしようとしている THE システムは現在のセッション状態を確認し、未認証の場合はログインページにリダイレクト SHALL する
5. WHEN ユーザーが明示的にログアウトする THEN システムは即座にセッションを無効化し、全ての認証状態をクリア SHALL する

### Requirement 5: セキュリティ機能
**User Story:** システム管理者として、セキュアな認証システムを実装したい。それにより、ユーザーデータを不正アクセスから保護できるため。

#### Acceptance Criteria

1. WHEN ユーザーがパスワードを設定する THEN システムはArgon2アルゴリズムでパスワードをハッシュ化して保存 SHALL する
2. WHERE パスワードデータが保存される THE システムは平文のパスワードを一切保存せず、ハッシュ化されたデータのみを保持 SHALL する
3. WHILE ユーザーがアプリケーションを利用している THE システムはHTTPS通信を強制し、HTTP接続をHTTPSにリダイレクト SHALL する
4. WHEN ユーザーがフォームを送信する THEN システムはCSRF攻撃対策として有効なCSRFトークンを検証 SHALL する
5. WHERE ユーザー入力データが処理される THE システムはXSS攻撃対策としてReactの自動エスケープ機能を活用し、SQLインジェクション対策としてDrizzle ORMのパラメータ化クエリを使用 SHALL する

### Requirement 6: データモデル・API統合
**User Story:** 開発者として、認証システムとアプリケーションの他の機能を統合したい。それにより、一貫性のあるユーザーエクスペリエンスを提供できるため。

#### Acceptance Criteria

1. WHEN ユーザーアカウントが作成される THEN システムはUsersテーブルに必要なフィールド（id, email, name, avatarUrl, monthlyGoal, yearlyGoal, createdAt, updatedAt）を持つレコードを作成 SHALL する
2. WHERE API エンドポイントが呼び出される THE システムはBetter Authのセッション情報を使用してユーザー認証状態を確認 SHALL する  
3. WHEN 認証済みユーザーが他の機能（本の登録、メンタルマップ作成等）を利用する THEN システムは現在のユーザーIDを自動的に関連データに紐付け SHALL する
4. IF ユーザーがアカウントを削除する THEN システムは関連する全てのデータ（本、メンタルマップ、読書記録）を含む完全なデータ削除を実行 SHALL する
5. WHERE TypeScript型定義が必要な箇所で THE システムはDrizzle ORMのinferSelect/inferInsert機能を使用して型安全なUser型を提供 SHALL する